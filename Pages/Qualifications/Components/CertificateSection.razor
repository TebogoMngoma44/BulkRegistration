@* CSS Reference Section *@
@@section Styles {
    <link rel="stylesheet" href="/css/certificate.css" />
}

@* @attribute [Authorize] *@
@using MudBlazor
@using Speccon.Learnership.FrontEnd.Models

@* 
<CascadingAuthenticationState>
    <AuthorizeView Context="CertificateSection">
        <Authorized>
*@
<MudCard Class="certificate-card">
    <MudCardContent>
        <MudStack Spacing="3">
            <MudStack AlignItems="AlignItems.Center" Spacing="2" Class="header-section">
                <MudText Typo="Typo.h5" Class="section-title" Style="color: #1e3a5f !important;">
                    Download Module Certificates
                </MudText>
                <MudText Typo="Typo.body1" Class="section-subtitle">
                    Download certificates for your completed modules
                </MudText>
            </MudStack>

            @if (GetCompletedModules().Any())
            {
                <MudStack Spacing="0">
                    <!-- Desktop Table Header -->
                    <MudPaper Class="table-header desktop-only" Elevation="0">
                        <MudGrid Spacing="0" AlignItems="AlignItems.Center">
                            <MudItem xs="1" Class="header-col header-col-1">
                                <MudText Typo="Typo.body1" Class="header-text">MODULE</MudText>
                            </MudItem>
                            <MudItem xs="3" Class="header-col header-col-2">
                                <MudText Typo="Typo.body1" Class="header-text">MODULE NAME</MudText>
                            </MudItem>
                            <MudItem xs="2" Class="header-col header-col-3">
                                <MudText Typo="Typo.body1" Class="header-text">COMPLETION DATE</MudText>
                            </MudItem>
                            <MudItem xs="2" Class="header-col header-col-4">
                                <MudText Typo="Typo.body1" Class="header-text">GRADE</MudText>
                            </MudItem>
                            <MudItem xs="2" Class="header-col header-col-5">
                                <MudText Typo="Typo.body1" Class="header-text">CERTIFICATE STATUS</MudText>
                            </MudItem>
                            <MudItem xs="2" Class="header-col header-col-6">
                                <MudText Typo="Typo.body1" Class="header-text">ACTION</MudText>
                            </MudItem>
                        </MudGrid>
                    </MudPaper>

                    <!-- Desktop Table Rows -->
                    @foreach (var module in GetCompletedModules())
                    {
                        <MudPaper Class="certificate-row desktop-only" Elevation="0">
                            <MudGrid Spacing="2" AlignItems="AlignItems.Center">
                                <MudItem xs="1">
                                    <MudAvatar Class="module-avatar" Size="Size.Medium">
                                        @module.ModuleNumber
                                    </MudAvatar>
                                </MudItem>
                                <MudItem xs="3">
                                    <MudStack Spacing="0">
                                        <MudText Typo="Typo.body1" Class="module-name">
                                            @module.ModuleName
                                        </MudText>
                                        <MudText Typo="Typo.body2" Class="qualification-name">
                                            @Qualification.QualificationName
                                        </MudText>
                                    </MudStack>
                                </MudItem>
                                <MudItem xs="2">
                                    <MudStack Spacing="0">
                                        <MudText Typo="Typo.body1" Class="completion-date">15 June 2025</MudText>
                                        <MudText Typo="Typo.body2" Class="completion-time">3 weeks ago</MudText>
                                    </MudStack>
                                </MudItem>
                                <MudItem xs="2">
                                    <MudStack Spacing="1" AlignItems="AlignItems.Center">
                                        <MudText Typo="Typo.h6" Class="grade-number">92%</MudText>
                                    </MudStack>
                                </MudItem>
                                <MudItem xs="2">
                                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                        <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Color="Color.Success" Size="Size.Small" />
                                        <MudText Typo="Typo.body2" Class="status-text">AVAILABLE</MudText>
                                    </MudStack>
                                </MudItem>
                                <MudItem xs="2">
                                    <MudButton Variant="Variant.Filled"
                                               StartIcon="@Icons.Material.Filled.FileDownload"
                                               Class="download-button"
                                               OnClick="(() => HandleDownloadCertificate(module.ModuleNumber))">
                                        DOWNLOAD CERTIFICATE
                                    </MudButton>
                                </MudItem>
                            </MudGrid>
                        </MudPaper>

                        <!-- Mobile Certificate Card -->
                        <MudPaper Class="certificate-card-mobile mobile-only" Elevation="1">
                            <MudStack Class="mobile-cert-header" Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Start" Spacing="2">
                                <MudStack Class="mobile-cert-title-section" Row="true" AlignItems="AlignItems.Start" Spacing="2">
                                    <MudAvatar Class="module-avatar-mobile" Size="Size.Medium">
                                        @module.ModuleNumber
                                    </MudAvatar>
                                    <MudStack Class="mobile-cert-info" Spacing="0">
                                        <MudText Typo="Typo.body1" Class="module-name-mobile">
                                            @module.ModuleName
                                        </MudText>
                                        <MudText Typo="Typo.body2" Class="qualification-name-mobile">
                                            @Qualification.QualificationName
                                        </MudText>
                                    </MudStack>
                                </MudStack>
                                <MudPaper Class="mobile-grade-badge" Elevation="0">
                                    <MudText Typo="Typo.h6" Class="grade-number-mobile">92%</MudText>
                                </MudPaper>
                            </MudStack>

                            <MudStack Class="mobile-cert-details" Spacing="2">
                                <MudStack Class="mobile-detail-row" Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Spacing="2">
                                    <MudText Typo="Typo.body2" Class="mobile-label">Completion Date:</MudText>
                                    <MudStack Class="mobile-value" Spacing="0" AlignItems="AlignItems.End">
                                        <MudText Typo="Typo.body2" Class="completion-date-mobile">15 June 2025</MudText>
                                        <MudText Typo="Typo.caption" Class="completion-time-mobile">3 weeks ago</MudText>
                                    </MudStack>
                                </MudStack>

                                <MudStack Class="mobile-detail-row" Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Spacing="2">
                                    <MudText Typo="Typo.body2" Class="mobile-label">Status:</MudText>
                                    <MudStack Class="mobile-status" Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                        <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Color="Color.Success" Size="Size.Small" />
                                        <MudText Typo="Typo.body2" Class="status-text-mobile">AVAILABLE</MudText>
                                    </MudStack>
                                </MudStack>
                            </MudStack>

                            <MudStack Class="mobile-cert-actions">
                                <MudButton Variant="Variant.Filled"
                                           StartIcon="@Icons.Material.Filled.FileDownload"
                                           Class="download-button-mobile"
                                           OnClick="(() => HandleDownloadCertificate(module.ModuleNumber))">
                                    <MudText Class="download-text-full">Download Certificate</MudText>
                                    <MudText Class="download-text-short">Download</MudText>
                                </MudButton>
                            </MudStack>
                        </MudPaper>
                    }
                </MudStack>
            }
            else
            {
                <MudStack AlignItems="AlignItems.Center" Spacing="2" Class="no-certificates">
                    <MudIcon Icon="@Icons.Material.Filled.Assignment" Color="Color.Default" Size="Size.Large" />
                    <MudText Typo="Typo.body1" Class="no-cert-title">
                        No completed modules available for certificate download
                    </MudText>
                    <MudText Typo="Typo.body2" Class="no-cert-subtitle">
                        Complete your modules to unlock certificates
                    </MudText>
                </MudStack>
            }
        </MudStack>
    </MudCardContent>
</MudCard>
@* </Authorized>
        <NotAuthorized>
            @{
                NavigationManager.NavigateTo("/auth/logout");
            }
        </NotAuthorized>
    </AuthorizeView>
</CascadingAuthenticationState> *@

@code {
    [Parameter] public SetaQualificationModel Qualification { get; set; } = new();
    [Parameter] public EventCallback<int> OnDownloadCertificate { get; set; }

    private async Task HandleDownloadCertificate(int moduleNumber)
    {
        // Handle certificate download logic
        await OnDownloadCertificate.InvokeAsync(moduleNumber);
    }

    private IEnumerable<Module> GetCompletedModules()
    {
        var completedModules = Qualification.Modules.Where(m => m.ProgressPercentage == 100).ToList();
        if (!completedModules.Any())
        {
            completedModules = Qualification.Modules.Where(m => m.ProgressPercentage >= 90).ToList();
        }
        if (!completedModules.Any())
        {
            completedModules = Qualification.Modules.Where(m => m.ModuleNumber <= 3).ToList();
        }
        return completedModules;
    }
}